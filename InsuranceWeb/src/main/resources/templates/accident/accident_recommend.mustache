<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
    <title>상해보험 추천 - 거북이 보험</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f8f9fa; padding-top: 80px; }
        .container { max-width: 800px; }
        .card { border: none; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .loading-spinner { display: none; }
        .results-div { display: none; margin-top: 2rem; }
        .product-card { background: white; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    </style>
</head>
<body>

{{>layout/header}}

<div class="container my-5">
    <div class="text-center mb-5">
        <h2>상해보험 맞춤 추천</h2>
        <p class="lead text-muted">몇 가지 정보만으로 최적의 상품을 찾아보세요.</p>
    </div>

    <div class="card p-4">
        <form id="recommendForm">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="age" class="form-label">나이</label>
                    <input type="number" class="form-control" id="age" value="40" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">성별</label>
                    <div class="pt-2">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="sex" id="sexM" value="M" checked>
                            <label class="form-check-label" for="sexM">남자</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="sex" id="sexF" value="F">
                            <label class="form-check-label" for="sexF">여자</label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <label for="sort-by" class="form-label">정렬 순서</label>
                <select class="form-select" id="sort-by">
                    <option value="default">추천 점수 순</option>
                    <option value="coverage_desc">보장금액 높은 순</option>
                    <option value="coverage_asc">보장금액 낮은 순</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary w-100 mt-3">나에게 맞는 상해보험 찾기</button>
        </form>
    </div>

    <div class="text-center mt-4 loading-spinner">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">최적의 상품을 분석 중입니다...</p>
    </div>

    <div class="results-div">
        <h3 class="mb-3">추천 결과</h3>
        <div id="resultsList"></div>
    </div>
</div>

{{>layout/footer}}

<script>
    document.getElementById('recommendForm').addEventListener('submit', function(event) {
        event.preventDefault();

        const age = document.getElementById('age').value;
        const sex = document.querySelector('input[name="sex"]:checked').value;

        const sortBy = document.getElementById('sort-by').value;

        const requestData = {
            age: parseInt(age),
            sex: sex,
            top_n: 5,
            sort_by: sortBy // API 요청에 정렬 값 추가
        };

        const spinner = document.querySelector('.loading-spinner');
        const resultsDiv = document.querySelector('.results-div');
        const resultsList = document.getElementById('resultsList');

        spinner.style.display = 'block';
        resultsDiv.style.display = 'none';
        resultsList.innerHTML = '';

        // 실제 API 엔드포인트에 맞게 URL을 수정해야 할 수 있습니다.
        fetch('/accident/recommend/api', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestData)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            console.log("브라우저가 받은 실제 데이터:", data);
            spinner.style.display = 'none';
            // API 응답 구조에 맞게 recommendations 키를 사용
            displayResults(data.recommendations);
        })
        .catch(error => {
            spinner.style.display = 'none';
            resultsList.innerHTML = '<div class="alert alert-danger">추천을 받아오는 중 오류가 발생했습니다.</div>';
            resultsDiv.style.display = 'block';
            console.error('Error:', error);
        });
    });

    function displayResults(products) {
        const resultsDiv = document.querySelector('.results-div');
        const resultsList = document.getElementById('resultsList');

        if (products && products.length > 0) {
            products.forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-card';

                card.innerHTML = `
                    <h5>${product.product_name} <small class="text-muted">(${product.insurance_company})</small></h5>
                    <hr>
                    <div class="row">
                        <div class="col-6"><strong>보장금액:</strong> ${product.coverage_amount ? product.coverage_amount.toLocaleString() + '원' : 'N/A'}</div>
                        <div class="col-6"><strong>갱신주기:</strong> ${product.renewal_cycle || 'N/A'}</div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-6"><strong>남자 보험료:</strong> ${product.male_premium ? product.male_premium.toLocaleString() + '원' : 'N/A'}</div>
                        <div class="col-6"><strong>여자 보험료:</strong> ${product.female_premium ? product.female_premium.toLocaleString() + '원' : 'N/A'}</div>
                    </div>
                `;

                resultsList.appendChild(card);
            });
        } else {
            resultsList.innerHTML = '<div class="alert alert-warning">조건에 맞는 상품을 찾을 수 없습니다.</div>';
        }
        resultsDiv.style.display = 'block';
    }
</script>
</body>
</html>