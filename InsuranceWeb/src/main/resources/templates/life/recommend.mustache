<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
    <title>종신보험 추천 - 거북이 보험</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"/>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f8f9fa;
            padding-top: 80px;
        }
        .custom-navbar {
            background-color: #1c2f48;
            border-bottom: 1px solid rgba(0,0,0,.25);
            padding: 8px 20px;
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
        }
        .custom-navbar .navbar-brand {
            color: #d4b46b !important;
            font-weight: 900;
            font-size: 40px;
            margin-right: 30px;
        }
        .custom-navbar .nav-link {
            color: #d4b46b !important;
            font-weight: 800;
            font-size: 20px;
            margin-right: 36px;
        }
        .custom-navbar .nav-link:hover {
            color: #e5c57b !important;
        }
        .recommend-form {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(28,47,72,0.1);
            padding: 2.5rem;
            margin-bottom: 2rem;
        }
        .form-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
        }
        .form-control, .form-select {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        .form-control:focus, .form-select:focus {
            border-color: #d4b46b;
            box-shadow: 0 0 0 0.2rem rgba(212,180,107,0.25);
        }
        .btn-primary {
            background-color: #1c2f48;
            border-color: #1c2f48;
            color: #d4b46b;
            border-radius: 10px;
            padding: 0.75rem 2rem;
            font-weight: 600;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            width: 100%;
        }
        .btn-primary:hover {
            background-color: #2a4a6f;
            border-color: #2a4a6f;
            color: #e5c57b;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(28,47,72,0.3);
        }
        .results-section {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            padding: 2rem;
            min-height: 600px;
        }
        .initial-message {
            text-align: center;
            color: #666;
            font-size: 1.1rem;
            margin-top: 3rem;
        }
        .loading-spinner {
            display: none;
            text-align: center;
            margin: 2rem 0;
        }
        .spinner-border {
            color: #1c2f48;
        }
        .section-title {
            font-weight: 700;
            color: #333;
            margin-bottom: 1.5rem;
            font-size: 1.3rem;
            border-bottom: 3px solid #d4b46b;
            padding-bottom: 0.5rem;
        }
        .chips {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        .chip {
            padding: 0.4rem 0.8rem;
            border: 1px solid #e2e6ef;
            border-radius: 999px;
            background: #fff;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }
        .chip:hover {
            background: #f3f6fb;
            border-color: #d4b46b;
        }
        .chip.active {
            background: #1c2f48;
            border-color: #1c2f48;
            color: #d4b46b;
            font-weight: 600;
        }
        .help-hint {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 0.3rem;
        }
        input[type=number]::-webkit-outer-spin-button,
        input[type=number]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
            appearance: textfield;
        }
        .result-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        .result-card:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        .product-header {
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }
        .company-name {
            color: #6c757d;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }
        .product-name {
            color: #333;
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 0;
        }
        .product-details {
            margin-top: 1rem;
        }
        .detail-item {
            margin-bottom: 0.75rem;
        }
        .detail-label {
            color: #6c757d;
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }
        .detail-value {
            color: #333;
            font-weight: 600;
            font-size: 1rem;
        }
        .result-count {
            background: linear-gradient(135deg, #1c2f48, #2a4a6b);
            color: #d4b46b;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
            font-weight: 600;
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="custom-navbar navbar navbar-expand-lg">
        <div class="container-fluid">
            <a class="navbar-brand" href="/main" style="color:#d4b46b; font-weight:900;">
                B
            </a>
            <div class="navbar-nav ms-auto">

                <a class="nav-link" href="/savings/recommend">연금보험</a>
                <a class="nav-link" href="/cancer/recommend">암보험</a>
                <a class="nav-link active" href="/life/recommend">종신보험</a>
                <a class="nav-link" href="/user/myPage">마이페이지</a>
                <a class="nav-link" href="/user/logout">로그아웃</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- 왼쪽 추천 설정 -->
            <div class="col-md-4">
                <div class="recommend-form">
                    <h3 class="section-title">종신보험 맞춤 추천</h3>
                    <p class="text-muted mb-4">나이, 성별, 직업, 예산 등을 입력하면 최적의 종신보험을 추천받으세요</p>
                    
                    <form id="recommendForm">
                        <div class="mb-3">
                            <label for="gender" class="form-label">성별</label>
                            <select id="gender" class="form-select" required>
                                <option value="">성별을 선택하세요</option>
                                <option value="남">남성</option>
                                <option value="여">여성</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="age" class="form-label">나이</label>
                            <select id="age" class="form-select" required>
                                <option value="">나이를 선택하세요</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="job" class="form-label">직업</label>
                            <select id="job" class="form-select" required>
                                <option value="">직업을 선택하세요</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">희망 월 보험료 (원)</label>
                            <input id="premium" type="number" class="form-control" placeholder="예) 50000">
                            <div class="chips" id="premiumChips"></div>
                            <div class="help-hint">※ 칩을 클릭하면 자동 입력됩니다</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">희망 보장금액 (원)</label>
                            <input id="coverage" type="number" class="form-control" placeholder="예) 10000000">
                            <div class="chips" id="coverageChips"></div>
                            <div class="help-hint">※ 원하는 금액을 선택하세요</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">정렬 기준</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="sort_by" value="premium" id="sort1" checked>
                                <label class="form-check-label" for="sort1">보험료 가까운 순</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="sort_by" value="coverage" id="sort2">
                                <label class="form-check-label" for="sort2">보장금액 가까운 순</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="sort_by" value="distance" id="sort3">
                                <label class="form-check-label" for="sort3">종합 추천</label>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label">추천 개수</label>
                            <input id="topk" type="number" class="form-control" value="10" min="1" max="20">
                        </div>

                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search me-2"></i>종신보험 찾기
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- 오른쪽 결과 -->
            <div class="col-md-8">
                <div class="results-section">
                    <h3 class="section-title">추천 결과</h3>
                    
                    <div class="initial-message">
                        <i class="fas fa-shield-alt fa-3x mb-3" style="color: #6c757d;"></i>
                        <h5 style="font-weight: 700; color: #333; margin-bottom: 0.5rem;">왼쪽 설정을 조정하고 "종신보험 찾기"를 클릭하세요!</h5>
                        <p style="color: #999; font-size: 1rem;">당신에게 최적화된 종신보험을 찾아드립니다.</p>
                    </div>
                    
                    <div class="loading-spinner" id="loadingSpinner">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">최적의 종신보험을 찾고 있습니다...</p>
                    </div>
                    
                    <div id="resultsContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const $ = (id) => document.getElementById(id);

        // 직업 옵션
        const JOB_OPTIONS = [
            "무직","학생","회사원","사무직","행정직","서비스직","판매직","마케터","콜센터","요식업","자영업",
            "의사","간호사","약사","회계사","법률사무","컨설턴트","연구원","교사","디자이너","HR","금융직",
            "기술직","엔지니어","개발자","전기공","항공정비사","철도작업자",
            "공무원","소방관","경찰","군인","운전기사","배달원","선원",
            "제조업라인","생산직","산업현장근로자","중장비기사","철강노동자",
            "건설업","벌목공","광부","잠수부","위험화학작업자",
            "농업","어업","요리사","주방","항만노동자"
        ].sort((a,b)=>a.localeCompare(b,'ko'));

        // 유틸 함수
        function toKRW(n) {
            if (n === null || n === undefined || isNaN(n)) return "-";
            return Number(n).toLocaleString("ko-KR");
        }

        function formatMoneyKRW(value) {
            if (value >= 100000000) {
                const eok = Math.floor(value / 100000000);
                const man = Math.floor((value % 100000000) / 10000);
                return man === 0 ? `${eok}억` : `${eok}억 ${man}만원`;
            }
            return `${(value/10000).toLocaleString("ko-KR")}만원`;
        }

        function renderChips(container, values, onPick) {
            container.innerHTML = "";
            values.forEach(v => {
                const chip = document.createElement("button");
                chip.type = "button";
                chip.className = "chip";
                chip.textContent = formatMoneyKRW(v);
                chip.addEventListener("click", () => {
                    [...container.querySelectorAll(".chip")].forEach(c => c.classList.remove("active"));
                    chip.classList.add("active");
                    onPick(v);
                });
                container.appendChild(chip);
            });
        }

        function fillAgeSelect() {
            const sel = $("age");
            for (let i=15; i<=80; i++) sel.innerHTML += `<option value="${i}">${i}세</option>`;
        }

        function fillJobSelect() {
            $("job").innerHTML += JOB_OPTIONS.map(j => `<option value="${j}">${j}</option>`).join("");
        }

        // 초기화
        document.addEventListener("DOMContentLoaded", () => {
            fillAgeSelect();
            fillJobSelect();

            // 보험료 칩 (1~20만원)
            const premiumValues = Array.from({length:20},(_,i)=>(i+1)*10000);
            renderChips($("premiumChips"), premiumValues, (val)=>{$("premium").value=val;});

            // 보장금액 칩
            const coveragePreset = [500,1000,1500,2000,3000,5000,10000,20000,30000,50000,100000,200000].map(m=>m*10000);
            renderChips($("coverageChips"), coveragePreset, (val)=>{$("coverage").value=val;});

            // 휠 스크롤 방지
            document.querySelectorAll('input[type=number]').forEach(el => {
                el.addEventListener('wheel', e => e.target.blur(), {passive:true});
            });
        });

        // 폼 제출
        document.getElementById('recommendForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // 로딩 표시
            document.querySelector('.initial-message').style.display = 'none';
            document.getElementById('loadingSpinner').style.display = 'block';
            document.getElementById('resultsContainer').innerHTML = '';
            
            const payload = {
                gender: $("gender").value,
                age: Number($("age").value),
                job: $("job").value,
                desiredPremium: Number($("premium").value || 0),
                desiredCoverage: Number($("coverage").value || 0),
                topk: Number($("topk").value || 10),
                sortBy: (document.querySelector('input[name="sort_by"]:checked')?.value) || "premium"
            };

            try {
                const response = await fetch('/life/recommend', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                
                document.getElementById('loadingSpinner').style.display = 'none';
                
                if (data.error) {
                    document.getElementById('resultsContainer').innerHTML = 
                        `<div class="alert alert-danger">${data.error}</div>`;
                    return;
                }

                const items = data.items || [];
                
                // 상품 정보 저장
                currentProducts = items;
                
                if (items.length === 0) {
                    document.getElementById('resultsContainer').innerHTML = 
                        `<div class="alert alert-warning">조건에 맞는 종신보험을 찾을 수 없습니다.</div>`;
                    return;
                }

                // 결과 카드 생성
                let html = `
                    <div class="result-count">
                        <i class="fas fa-check-circle me-2"></i>
                        총 ${items.length}개의 종신보험을 찾았습니다!
                    </div>
                `;

                items.forEach((item, index) => {
                    const name = item.product || item.name || item['상품명'] || '-';
                    const premium = item.productPremium || item.premium || item['보험료'];
                    const coverage = item.productCoverage || item.coverage || item['지급금액'];
                    const company = item.company || item['보험회사'] || '정보없음';
                    
                    html += `
                        <div class="result-card">
                            <div class="product-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="company-name">${company}</div>
                                        <div class="product-name">${name}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="product-details">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="detail-item">
                                            <div class="detail-label">보장금액</div>
                                            <div class="detail-value">${toKRW(coverage)}원</div>
                                        </div>
                                        <div class="detail-item">
                                            <div class="detail-label">월 보험료</div>
                                            <div class="detail-value">${toKRW(premium)}원</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="detail-item">
                                            <div class="detail-label">보험 유형</div>
                                            <div class="detail-value">종신보험</div>
                                        </div>
                                        <div class="detail-item">
                                            <div class="detail-label">추천 순위</div>
                                            <div class="detail-value">${index + 1}위</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 관심 상품 추가 버튼 -->
                                <div class="text-end mt-3">
                                    <button class="btn btn-primary" onclick="addToCart(${index})">
                                        관심 상품
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += `
                    <small class="text-muted">※ 실제 보험료는 조건 및 특약에 따라 달라질 수 있습니다.</small>
                `;

                document.getElementById('resultsContainer').innerHTML = html;

            } catch (error) {
                document.getElementById('loadingSpinner').style.display = 'none';
                document.getElementById('resultsContainer').innerHTML = 
                    `<div class="alert alert-danger">추천 요청 중 오류가 발생했습니다: ${error.message}</div>`;
                console.error('Error:', error);
            }
        });

        // 관심 상품 추가 기능
        let currentProducts = [];

        function addToCart(index) {
            const product = currentProducts[index];
            if (!product) {
                alert('상품 정보를 찾을 수 없습니다.');
                return;
            }

            const cartData = {
                insuranceType: "종신보험",
                insuranceCompany: product.company || product['보험회사'] || '',
                productName: product.product || product.name || product['상품명'] || '',
                coverageAmount: product.productCoverage || product.coverage || product['지급금액'] || '',
                malePremium: product.productPremium || product.premium || product['보험료'] || '',
                femalePremium: product.productPremium || product.premium || product['보험료'] || '',
                renewalCycle: '종신',
                term: '종신',
                salesChannel: '온라인',
                recommendationReason: '종신보험 추천 시스템'
            };

            fetch('/cart/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(cartData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                } else {
                    if (data.message.includes('로그인')) {
                        if (confirm('로그인이 필요합니다. 로그인 페이지로 이동하시겠습니까?')) {
                            window.location.href = '/user/login';
                        }
                    } else {
                        alert(data.message);
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('관심 상품 추가 중 오류가 발생했습니다.');
            });
        }

        // 결과 표시 시 상품 정보 저장
        function displayResults(items) {
            currentProducts = items || [];
        }
    </script>
</body>
</html>
